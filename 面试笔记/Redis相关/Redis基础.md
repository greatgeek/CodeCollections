# Redis 基础

## Redis 有哪些数据结构？

String, Hash, List, Set, SortedSet. 还有像 BloomFilter 用来判断是否存在数据集中的数据结构。

## 如果有大量的 Key 需要设置同一时间过期，一般需要注意什么？

如果大量的 key 过期时间设置的过于集中，到过期的那个时间点， Redis 可能会出现短暂的卡顿现象。严重的话会出现缓存雪崩，我们一般需要在过期时间上加一个随机值，使得过期时间分散一些。

电商首页经常会使用定时任务刷新缓存，可能大量的数据失效时间都十分集中，如果失效时间一样，又刚好在失效时间点大量用户涌入，就有可能造成缓存雪崩。

## 使用过Redis 分布式锁么，它是什么回事？

先拿 setnx 来争抢锁，抢到之后，再用 expire 给锁加一个过期时间防止锁忘记释放。

## 如果在 setnx 之后执行 expire 之前进程意外 crash 或者要重启维护了，那会怎样？

那这个锁就永远得不到释放了，不过 set 指令有非常复杂的参数，这个应该是可以同时把 setnx 和 expire 合成一条指令来用的。

## 假如 Redis 里面有1亿个 key，其中有10w 个key 是以某个固定的已知的前缀开头的，如何将它们全部找出来？

使用 keys 指令可以扫出指定模式的 key 列表。

## 如果这个 redis 正在给线上的业务提供服务，那使用 keys 指令会有什么问题？

Redis 是单线程的。keys 指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用 scan 指令， scan 指令可以无阻塞的提取指定模式的 key 列表，但是会有一定的重复概率，在客户端做一次去重就可以了，但是整体所花费的时间会比直接 keys 指令长。

不过，**增量式迭代命令**是有缺点的。例如，使用 smembers 命令可以返回集合键当前包含的所有元素， 但是对于 scan 这类增量式迭代命令来说，因为在对键进行增量迭代的过程中，键可能会被修改，所以增量式迭代命令只能对被返回的元素提供有限的保证。

## 使用过 Redis 做异步队列么，你是怎么用的？

一般使用 list 结构作为队列，rpush 生产消息， lpop 消费消息。当 lpop 没有消息的时候，要适当 sleep 一会再重试。

## 如果对方追问可不可以不用 sleep 呢？

list 还有个指令叫 blpop，在没有消息时，它会阻塞住直到消息的到来。

## 如果对方接着追问能不能生产一次消费多次呢？

使用 pub/sub 主题订阅者模式，可以实现 1:N 的消息队列。

## 如果对方继续追问 pub/sub 有什么缺点？

在消费者下线的情况下，生产的消息会丢失，得使用专业的消息队列如 RocketMQ等。

## Redis 如何实现延时队列？

使用 sortedset，拿时间戳作为 score， 消息内容作为 key 调用 zadd 来生产消息，消费者用 zrangebyscore 指令获取N 秒之前 的数据轮询进行处理。

## Redis 是怎么持久化的？服务主从数据怎么交互的？

RDB 做镜像全量持久化， AOF 做增量持久化。因为RDB会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据,所以需要AOF来配合使用. 在Redis 实例重启时,会使用RDB持久化文件重新构建内存,再使用AOF存放近期的操作指令来实现完整恢复重启之前的状态.

这里很好理解,把RDB理解为一整个表全量的数据,AOF理解 为每次操作的日志就好了,服务器重启时先把表的数据全部搞进去,但是可能不完整,你再放一下日志,数据不就完整了么.不过Redis 本身的机制是 AOF 持久化开启且存在AOF文件时,优先加载AOF文件;AOF关闭或者AOF文件不存在时,加载RDB文件;加载AOF/RDB文件完成后,Redis 启动成功;AOF/RDB 文件存在错误时,Redis 启动失败并打印错误信息.

## 如果突然机器掉电会怎么样?

取决于AOF日志sync 属性的配置,如果不要求性能,在每条写指令时都 sync 一下磁盘,就不会丢失数据.但是在高性能的要求下每次都 sync 是不现实的,一般都使用 sync, 比如 1s1次,这个时候最多就会丢失1s 的数据.

## 对方追问RDB的原理是什么?

fork 和 cow. fork 是指 redis 通过创建子进程来进行RDB操作, cow 指的是 copy on write, 子进程创建后,父子进程共享数据段,父进程继续提供读写服务,写脏的页面数据会逐渐和子进程分离开来.

## Pipeline 有什么好处,为什么要用 pipeline?

可以将多次IO往返的时间缩减为一次,前提是 pipeline 执行的指令之间没有因果相关性. 使用 redis-benchmark 进行压测时可以发现影响 redis 的QPS峰值的一个重要因素是 pipeline 批次指令的数目.

## Redis 的同步机制了解么?

Redis 可以使用主从同步, 从从同步. 第一次同步时,主节点做一次 bgsave, 并同时将后续修改操作记录到内存 buffer , 待完成后将 RDB 文件全量同步到复制节点,复制节点接受完成后将RDB镜像加载到内存. 加载完成后,再通知主节点将期间修改的操作记录同步到复制节点进行重放就完成了同步过程. 后续的增量数据通过 AOF 日志同步即可,有点类似数据库的 binlog.

## 是否使用过 Redis 集群,集群的高可用怎么保证,集群的原理是什么?

Redis Sentinal 着眼于高可用,在 master 宕机时会自动将 slave 提升为 master, 继续提供服务.

Redis Cluster 着眼于扩展性,在单个 redis 内存不足时,使用 Cluster 进行分片存储.